<!DOCTYPE html>
<html>

<head>
  <title>Bouncing Ball</title>
  <style>
    html,
    body {
      background: black;
      color: white;
    }
  </style>
</head>

<body>
  <h1>Circle gets smaller until my computer crashes ðŸ’€</h1>
  <canvas id="canvas"></canvas>
  <p>Bounces: <span id="bounceCount">0</span></p>
  <script type="text/javascript">
    function clearCanvas(ctx, width, height) {
      ctx.clearRect(0, 0, width, height)
    }

    function drawCircle(ctx, circle) {
      ctx.beginPath()
      ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI)

      if (circle.fillColor) {
        ctx.fillStyle = circle.fillColor
        ctx.fill()
      }

      if (circle.strokeColor && circle.lineWidth) {
        ctx.lineWidth = circle.lineWidth
        ctx.strokeStyle = circle.strokeColor
        ctx.stroke()
      }
    }

    function isCircleTouchingFromInside(innerCircle, outerCircle) {
      let dx = innerCircle.x - outerCircle.x
      let dy = innerCircle.y - outerCircle.y

      let euclidianDistance = Math.sqrt(dx * dx + dy * dy)

      return euclidianDistance + innerCircle.radius >= outerCircle.radius
    }

    function bounce(innerCircle, outerCircle, bounciness) {
      let dx = innerCircle.x - outerCircle.x
      let dy = innerCircle.y - outerCircle.y

      let distance = Math.sqrt(dx * dx + dy * dy)
      dx /= distance
      dy /= distance

      let angle = Math.atan2(dy, dx)

      let randomAngle = (Math.random() - 0.5) * Math.PI / 4 // random value between -45 and 45 degrees

      angle += randomAngle

      innerCircle.vx = -Math.cos(angle) * bounciness
      innerCircle.vy = -Math.sin(angle) * bounciness
    }

    function randomColor() {
      let r = Math.floor(Math.random() * 256)
      let g = Math.floor(Math.random() * 256)
      let b = Math.floor(Math.random() * 256)
      return `rgb(${r},${g},${b})`
    }

    let c = document.getElementById('canvas')
    let ctx = c.getContext('2d')

    const fps = 60

    const width = 300
    const height = 300

    let bounciness = 8
    let gravity = 0.2

    // retina scaling
    let dpr = window.devicePixelRatio || 1
    c.width = width * dpr
    c.height = height * dpr
    c.style.width = `${width}px`
    c.style.height = `${height}px`
    ctx.scale(dpr, dpr)

    let outerCircle = {
      x: width / 2,
      y: height / 2,
      vx: 0,
      vy: 0,
      radius: width / 2.1,
      lineWidth: 2,
      strokeColor: 'white',
      fillColor: ''
    }

    let innerCircle = {
      x: width / 2,
      y: height / 2,
      vx: Math.random(), // randomize to start
      vy: Math.random(),
      radius: width / 24,
      fillColor: 'white'
    }

    setInterval(() => {
      clearCanvas(ctx, width, height)

      drawCircle(ctx, outerCircle)
      drawCircle(ctx, innerCircle)

      innerCircle.vy += gravity

      innerCircle.y += innerCircle.vy
      innerCircle.x += innerCircle.vx

      if (isCircleTouchingFromInside(innerCircle, outerCircle)) {
        innerCircle.fillColor = randomColor()
        outerCircle.strokeColor = randomColor()
        outerCircle.radius *= 0.99
        bounciness *= 1.01
        bounce(innerCircle, outerCircle, bounciness)

        document.getElementById('bounceCount').innerText = parseInt(document.getElementById('bounceCount').innerText) + 1
      }
    }, 1000 / fps)
  </script>
</body>

</html>