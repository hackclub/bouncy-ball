<!DOCTYPE html>
<html onclick="start()">

<head>
  <title>Bouncing Ball</title>
  <meta charset="utf-8">
  <style>
    html,
    body {
      background: black;
      color: white;
      text-align: center;
      font-family: 'Courier New', Courier, monospace;
      font-size: 22px;
    }

    h1 {
      margin-top: 200px;
    }
  </style>
</head>

<body>
  <h1>Circle gets smaller until my computer crashes ðŸ’€</h1>
  <canvas id="canvas"></canvas>
  <p>Bounces: <span id="bounceCount">0</span></p>
  <script type="module">
    import Song from './song.js'

    function clearCanvas(ctx, width, height) {
      ctx.clearRect(0, 0, width, height)
    }

    function drawCircle(ctx, circle) {
      ctx.beginPath()
      ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI)

      if (circle.fillColor) {
        ctx.fillStyle = circle.fillColor
        ctx.fill()
      }

      if (circle.strokeColor && circle.lineWidth) {
        ctx.lineWidth = circle.lineWidth
        ctx.strokeStyle = circle.strokeColor
        ctx.stroke()
      }
    }

    function isCircleTouchingFromInside(innerCircle, outerCircle) {
      let dx = innerCircle.x - outerCircle.x
      let dy = innerCircle.y - outerCircle.y

      let euclidianDistance = Math.sqrt(dx * dx + dy * dy)

      return euclidianDistance + innerCircle.radius >= outerCircle.radius
    }

    function positionInnerCircleAtClosestTouchingPoint(innerCircle, outerCircle) {
      let dx = innerCircle.x - outerCircle.x
      let dy = innerCircle.y - outerCircle.y

      let distance = Math.sqrt(dx * dx + dy * dy)

      if (distance > outerCircle.radius - innerCircle.radius) {
        let directionX = dx / distance
        let directionY = dy / distance

        innerCircle.x = outerCircle.x + directionX * (outerCircle.radius - innerCircle.radius)
        innerCircle.y = outerCircle.y + directionY * (outerCircle.radius - innerCircle.radius)
      }
    }

    function bounce(innerCircle, outerCircle, bounciness) {
      let dx = innerCircle.x - outerCircle.x
      let dy = innerCircle.y - outerCircle.y

      let distance = Math.sqrt(dx * dx + dy * dy)
      dx /= distance
      dy /= distance

      let angle = Math.atan2(dy, dx)

      let randomAngle = (Math.random() - 0.5) * Math.PI / 4 // random value between -45 and 45 degrees

      angle += randomAngle

      innerCircle.vx = -Math.cos(angle) * bounciness
      innerCircle.vy = -Math.sin(angle) * bounciness
    }

    let hue = 0

    function randomColor() {
      hue = (hue + 3) % 360
      return `hsl(${hue}, 100%, 50%)`
    }

    let c = document.getElementById('canvas')
    let ctx = c.getContext('2d')

    const fps = 60

    const width = 600
    const height = 600

    let bounciness = 30
    let gravity = 1

    // retina scaling
    let dpr = window.devicePixelRatio || 1
    c.width = width * dpr
    c.height = height * dpr
    c.style.width = `${width}px`
    c.style.height = `${height}px`
    ctx.scale(dpr, dpr)

    let outerCircle = {
      x: width / 2,
      y: height / 2,
      vx: 0,
      vy: 0,
      radius: width / 2.1,
      lineWidth: 5,
      strokeColor: 'white',
      fillColor: ''
    }

    let innerCircle = {
      x: width / 2,
      y: height / 2,
      vx: Math.random(), // randomize to start
      vy: Math.random(),
      radius: width / 32,
      fillColor: 'white',
      strokeColor: 'black',
      lineWidth: 2
    }

    window.start = async function start() {
      let song = new Song('https://cloud-lrvp6ww5x-hack-club-bot.vercel.app/0dr_dre_-_still_dre.mid')
      await song.setup()

      setInterval(() => {
        innerCircle.vy += gravity

        innerCircle.y += innerCircle.vy
        innerCircle.x += innerCircle.vx

        let color = randomColor()
        innerCircle.fillColor = color
        outerCircle.strokeColor = color

        if (isCircleTouchingFromInside(innerCircle, outerCircle)) {
          positionInnerCircleAtClosestTouchingPoint(innerCircle, outerCircle)

          song.playNote()

          outerCircle.radius -= 2
          innerCircle.radius += 1
          bounciness *= 0.98
          bounce(innerCircle, outerCircle, bounciness)

          document.getElementById('bounceCount').innerText = parseInt(document.getElementById('bounceCount').innerText) + 1
        }

        // clearCanvas(ctx, width, height)

        drawCircle(ctx, outerCircle)
        drawCircle(ctx, innerCircle)
      }, 1000 / fps)
    }

  </script>
</body>

</html>