<!DOCTYPE html>
<html onclick="start()">

<head>
  <title>Bouncing Ball</title>
  <meta charset="utf-8">
  <style>
    html,
    body {
      background: black;
      color: white;
      text-align: center;
      font-family: 'Courier New', Courier, monospace;
      font-size: 16px;
    }

    h1 {
      margin-top: 200px;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    p {
      margin-top: 720px;
      font-size: 28px;
    }
  </style>
</head>

<body>
  <h1>Add a line every bounce until<br>my computer crashes ðŸ’€</h1>
  <canvas id="canvas"></canvas>
  <p>Bounces: <span id="bounceCount">0</span></p>
  <script type="module">
    // setup
    let c = document.getElementById('canvas')
    let ctx = c.getContext('2d')

    // setup - note - we can change these numbers
    const width = window.innerWidth
    const height = window.innerHeight

    // setup - retina scaling
    let dpr = window.devicePixelRatio || 1
    c.width = width * dpr
    c.height = height * dpr
    c.style.width = `${width}px`
    c.style.height = `${height}px`
    ctx.scale(dpr, dpr)

    // our code begins in earnest

    import Circle from './circle.js'
    import Song from './song.js'

    function clearCanvas(ctx, width, height) {
      ctx.clearRect(0, 0, width, height)
    }

    let hue = 0

    function randomColor() {
      hue = (hue + 3) % 360
      return `hsl(${hue}, 100%, 50%)`
    }

    let reverseHue = 0

    function reverseRandomColor() {
      reverseHue = (reverseHue - 3) % 360
      return `hsl(${reverseHue}, 100%, 50%)`
    }

    const fps = 60

    let bounciness = 15
    let gravity = 0.5

    let outerCircle = new Circle({
      x: width / 2,
      y: height / 2,
      vx: 0,
      vy: 0,
      radius: width / 2.4,
      lineWidth: 5,
      strokeColor: 'white',
      fillColor: ''
    })

    let innerCircle = new Circle({
      x: width / 2,
      y: height / 2,
      vx: Math.random(), // randomize to start
      vy: Math.random(),
      radius: width / 32,
      fillColor: 'white',
      strokeColor: 'black',
      lineWidth: 2
    })

    let bounceCoords = []

    window.start = async function start() {
      let song = new Song('https://cloud-7qo1v7e36-hack-club-bot.vercel.app/0gravity_falls_-_made_me_realize.mid')
      await song.setup()

      // this code runs 60 times per second (or whatever we set fps to)
      setInterval(() => {
        innerCircle.vy += gravity

        innerCircle.update()
        outerCircle.update()

        let color = randomColor()
        innerCircle.fillColor = color
        outerCircle.strokeColor = color

        if (bounceCoords.length > 25) outerCircle.radius += 0.1
        if (bounceCoords.length > 90) outerCircle.radius += 0.15

        if (innerCircle.isOutsideCircle(outerCircle)) {
          bounceCoords.push(outerCircle.closestPoint(innerCircle.x, innerCircle.y))

          // this makes it so the circle isn't drawn outside of the outerCircle
          innerCircle.moveToClosestPointOfCircle(outerCircle)
          innerCircle.bounceAgainstCircle(outerCircle, bounciness)

          song.playNote()

          // outerCircle.radius *= 0.99
          // innerCircle.radius *= 1.1
          if (bounciness < 70) bounciness *= 1.05

          if (bounceCoords.length > 70) bounciness += 0.75
          if (bounceCoords.length > 120) bounciness += 1
          // if (bounceCoords.length > 160) bounciness += 1


          gravity *= 0.95

          console.log(bounciness, gravity)

          document.getElementById('bounceCount').innerText = parseInt(document.getElementById('bounceCount').innerText) + 1
        }

        clearCanvas(ctx, width, height)

        let bounceColor = reverseRandomColor()

        bounceCoords.forEach(coord => {
          let c = outerCircle.closestPoint(coord.x, coord.y)
          ctx.beginPath()
          ctx.moveTo(c.x, c.y)
          ctx.lineTo(innerCircle.x, innerCircle.y)
          ctx.lineWidth = 1
          ctx.strokeStyle = bounceColor
          ctx.stroke()
        })

        innerCircle.draw(ctx)
        outerCircle.draw(ctx)
      }, 1000 / fps)
    }

  </script>
</body>

</html>