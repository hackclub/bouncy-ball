<!DOCTYPE html>
<html onclick="start()">

<head>
  <title>Bouncing Ball</title>
  <meta charset="utf-8">
  <style>
    html,
    body {
      background: black;
      color: white;
      text-align: center;
      font-family: 'Courier New', Courier, monospace;
      font-size: 22px;
    }

    h1 {
      margin-top: 200px;
    }
  </style>
</head>

<body>
  <h1>Welcome to the black parade ðŸ’€</h1>
  <canvas id="canvas"></canvas>
  <p>Bounces: <span id="bounceCount">0</span></p>
  <script type="module">
    // setup
    let c = document.getElementById('canvas')
    let ctx = c.getContext('2d')

    // setup - note - we can change these numbers
    const width = 600
    const height = 600

    // setup - retina scaling
    let dpr = window.devicePixelRatio || 1
    c.width = width * dpr
    c.height = height * dpr
    c.style.width = `${width}px`
    c.style.height = `${height}px`
    ctx.scale(dpr, dpr)

    // our code begins in earnest

    import Circle from './circle.js'
    import Song from './song.js'

    function clearCanvas(ctx, width, height) {
      ctx.clearRect(0, 0, width, height)
    }

    let hue = 0

    function randomColor() {
      hue = (hue + 3) % 360
      return `hsl(${hue}, 100%, 50%)`
    }

    const fps = 60

    let bounciness = 20
    let gravity = 0.5

    let outerCircle = new Circle({
      x: width / 2,
      y: height / 2,
      vx: 0,
      vy: 0,
      radius: width / 2.1,
      lineWidth: 5,
      strokeColor: 'white',
      fillColor: ''
    })

    let innerCircle = new Circle({
      x: width / 2,
      y: height / 2,
      vx: Math.random(), // randomize to start
      vy: Math.random(),
      radius: width / 32,
      fillColor: 'white',
      strokeColor: 'black',
      lineWidth: 2
    })

    let bounceCoords = []

    window.start = async function start() {
      let song = new Song('https://cloud-mkucvezdj-hack-club-bot.vercel.app/0my_chemical_romance_-_welcome_to_the_black_parade.mid.mid')
      await song.setup()

      // this code runs 60 times per second (or whatever we set fps to)
      setInterval(() => {
        innerCircle.vy += gravity

        innerCircle.update()
        outerCircle.update()

        let color = randomColor()
        innerCircle.fillColor = color
        outerCircle.strokeColor = color

        if (innerCircle.isOutsideCircle(outerCircle)) {
          // this makes it so the circle isn't drawn outside of the outerCircle
          innerCircle.moveToClosestPointOfCircle(outerCircle)

          bounceCoords.push(outerCircle.closestPoint(innerCircle.x, innerCircle.y))

          song.playNote()

          outerCircle.radius -= 1.5
          innerCircle.radius *= 1.1
          bounciness *= 0.98

          innerCircle.bounceAgainstCircle(outerCircle, bounciness)

          document.getElementById('bounceCount').innerText = parseInt(document.getElementById('bounceCount').innerText) + 1
        }

        // clearCanvas(ctx, width, height)

        bounceCoords.forEach(coord => {
          let c = outerCircle.closestPoint(coord.x, coord.y)
          ctx.beginPath()
          ctx.moveTo(c.x, c.y)
          ctx.lineTo(innerCircle.x, innerCircle.y)
          ctx.lineWidth = 2
          ctx.strokeStyle = 'black'
          ctx.stroke()
        })

        innerCircle.draw(ctx)
        outerCircle.draw(ctx)
      }, 1000 / fps)
    }

  </script>
</body>

</html>